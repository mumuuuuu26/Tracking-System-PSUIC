generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//ระบบจัดการผู้ใช้ (USER)
model User {
  id        Int      @id @default(autoincrement())
  username  String?  @unique // Student ID (PSU Passport)
  email     String   @unique
  password  String?
  name      String?
  picture   String?
  role      String   @default("user") // user, it_support, admin
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticketsCreated  Ticket[]         @relation("TicketCreator")
  ticketsAssigned Ticket[]         @relation("TicketAssignee")
  appointments    Appointment[]
  availabilities  ITAvailability[] // [New] ตารางงานพี่เจย์
}

//หมวดหมู่ปัญหา (CATEGORY) - [New Req]
model Category {
  id      Int      @id @default(autoincrement())
  name    String   @unique // Hardware, Software, Network
  tickets Ticket[]
}

//ระบบจัดการห้อง (ROOM)
model Room {
  id         Int         @id @default(autoincrement())
  roomNumber String      @unique
  building   String?
  floor      Int?
  equipments Equipment[]
  tickets    Ticket[]
}

//ระบบจัดการอุปกรณ์ (EQUIPMENT)
model Equipment {
  id       Int      @id @default(autoincrement())
  name     String
  type     String
  serialNo String?  @unique
  status   String   @default("Normal")
  roomId   Int
  room     Room     @relation(fields: [roomId], references: [id])
  tickets  Ticket[]
}

//ระบบแจ้งซ่อม (TICKET) - ศูนย์กลาง
model Ticket {
  id          Int    @id @default(autoincrement())
  title       String
  description String @db.Text
  urgency     String @default("Normal")

  //[New Req] เพิ่มสถานะ Draft และ Cancelled
  status String @default("Draft")

  //[New Req] การประเมินความพึงพอใจ
  rating       Int? // 1-5 ดาว
  userFeedback String? @db.Text

  //ความสัมพันธ์
  createdById Int
  createdBy   User @relation("TicketCreator", fields: [createdById], references: [id])

  assignedToId Int?
  assignedTo   User? @relation("TicketAssignee", fields: [assignedToId], references: [id])

  roomId Int
  room   Room @relation(fields: [roomId], references: [id])

  equipmentId Int?
  equipment   Equipment? @relation(fields: [equipmentId], references: [id])

  //[New Req] เชื่อมกับหมวดหมู่
  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  images      Image[]
  logs        ActivityLog[]
  appointment Appointment?
}

//ตารางงาน IT Support (IT AVAILABILITY) - [New Req]
model ITAvailability {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id])

  date      DateTime
  status    String // "Busy", "Available", "Leave"
  title     String?
  startTime DateTime?
  endTime   DateTime?
  createdAt DateTime  @default(now())
}

//ระบบการนัดหมาย (APPOINTMENT)
model Appointment {
  id       Int    @id @default(autoincrement())
  ticketId Int    @unique
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  itSupportId Int
  itSupport   User @relation(fields: [itSupportId], references: [id])

  scheduledAt   DateTime
  note          String?  @db.Text
  googleEventId String? // เผื่อเชื่อม Calendar

  createdAt DateTime @default(now())
}

//บันทึกกิจกรรม (ACTIVITY LOG)
model ActivityLog {
  id       Int    @id @default(autoincrement())
  ticketId Int
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  action    String
  detail    String?  @db.Text
  updatedBy String
  createdAt DateTime @default(now())
}

//ระบบรูปภาพ (IMAGE)
model Image {
  id         Int    @id @default(autoincrement())
  asset_id   String
  public_id  String
  url        String
  secure_url String
  type       String @default("before")

  ticketId  Int
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}
