name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: ticket_system_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install All Dependencies
      run: |
        npm ci
        cd client && npm ci

    - name: Setup Environment Variables
      run: |
        cp .env.example .env || echo "DATABASE_URL=mysql://root:password@localhost:3306/ticket_system_test" > .env
        echo "JWT_SECRET=supersecret" >> .env
        cd client && echo "VITE_API_URL=/api" > .env

    - name: Generate Prisma Client
      run: npx prisma generate

    - name: Sync Database Schema
      run: npx prisma db push --accept-data-loss
      env:
        DATABASE_URL: mysql://root:password@localhost:3306/ticket_system_test

    - name: Run Backend Tests
      run: npm test
      env:
        NODE_ENV: test
        DATABASE_URL: mysql://root:password@localhost:3306/ticket_system_test

    # --------------------------------------------------------
    # 1. Seed à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (à¹ƒà¸Šà¹‰à¹„à¸Ÿà¸¥à¹Œ seed-complete.js à¸—à¸µà¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸£à¸š)
    # --------------------------------------------------------
    - name: Seed Database for E2E
      run: node prisma/seed-complete.js
      env:
        DATABASE_URL: mysql://root:password@localhost:3306/ticket_system_test

    # 2. à¹€à¸Šà¹‡à¸„à¹ƒà¸«à¹‰à¸Šà¸±à¸§à¸£à¹Œà¸§à¹ˆà¸²à¹€à¸‚à¹‰à¸²à¹à¸¥à¹‰à¸§ (à¹€à¸à¸´à¹ˆà¸¡ Step à¸™à¸µà¹‰à¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸šà¸²à¸¢à¹ƒà¸ˆ à¸”à¸¹à¹ƒà¸™ Log à¹„à¸”à¹‰à¹€à¸¥à¸¢)
    - name: Verify Database Content
      run: |
        node -e '
          const { PrismaClient } = require("@prisma/client");
          const prisma = new PrismaClient();
          prisma.category.count().then(c => console.log("DEBUG: Category Count =", c));
        '
      env:
        DATABASE_URL: mysql://root:password@localhost:3306/ticket_system_test

    # ğŸ‘‡ğŸ‘‡ğŸ‘‡ 3. à¹€à¸à¸´à¹ˆà¸¡ Step à¸™à¸µà¹‰à¸„à¸£à¸±à¸š (à¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”!) ğŸ‘‡ğŸ‘‡ğŸ‘‡
    - name: Remove .env to force Server to use CI Environment
      run: rm .env
    # ğŸ‘†ğŸ‘†ğŸ‘† à¸¥à¸š .env à¸—à¸´à¹‰à¸‡ à¹€à¸à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰ Server à¸«à¸¥à¸‡à¹„à¸›à¹ƒà¸Šà¹‰ DB à¸œà¸´à¸”à¸•à¸±à¸§ ğŸ‘†ğŸ‘†ğŸ‘†

    - name: Run Frontend Tests
      run: |
        cd client
        npm test

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run E2E Tests
      run: npm run test:e2e:ci
      env:
        DATABASE_URL: mysql://root:password@localhost:3306/ticket_system_test
        PORT: 5002
        SECRET: test_secret
        CLIENT_URL: http://localhost:5173
        FRONTEND_URL: http://localhost:5173
        CI: true

    - name: Upload Playwright Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
