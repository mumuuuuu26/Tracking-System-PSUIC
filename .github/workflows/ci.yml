name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: ticket_system_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install All Dependencies
      run: |
        npm ci
        cd client && npm ci

    - name: Setup Environment Variables
      run: |
        cp .env.example .env || echo "DATABASE_URL=mysql://root:password@localhost:3306/ticket_system_test" > .env
        echo "JWT_SECRET=supersecret" >> .env
        cd client && echo "VITE_API_URL=/api" > .env

    - name: Run Database Migrations
      run: npx prisma migrate deploy
      env:
        DATABASE_URL: mysql://root:password@localhost:3306/ticket_system_test

    - name: Run Backend Tests
      run: npm test
      env:
        NODE_ENV: test
        DATABASE_URL: mysql://root:password@localhost:3306/ticket_system_test

    - name: Run Frontend Tests
      run: |
        cd client
        npm test

    # - name: Install Playwright Browsers
    #   run: npx playwright install --with-deps

    # - name: Run E2E Tests
    #   run: npm run test:e2e
    #   env:
    #     NODE_ENV: test
    #     DATABASE_URL: mysql://root:password@localhost:3306/ticket_system_test
    #     CI: true

    # - name: Upload Playwright Report
    #   if: always()
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: playwright-report
    #     path: playwright-report/
    #     retention-days: 30
